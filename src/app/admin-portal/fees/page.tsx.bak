'use client';

import { useEffect, useState } from 'react';

import Link from 'next/link';
import { useRouter } from 'next/navigation';

import { useUserDataRedux } from '@/hooks/useUserDataRedux';
import { useGetClassesQuery } from '@/store/api/classApi';
import { makeApiCall } from '@/utils/ApiRequest';

// Types
type FeeType =
  | 'Monthly Fee'
  | 'Exam Fee'
  | 'Registration Fee'
  | 'Admission Fee'
  | 'Other Fees';

interface FeeComponent {
  type: FeeType;
  amount: number;
  isPaid: boolean;
  dueDate?: string;
  month?: string;
}

interface FeeStructure {
  id: string;
  className: string;
  academicYear: string;
  totalAmount: number;
  components: {
    admissionFee: number;
    registrationFee: number;
    tuitionFees: number;
    examFees: number;
    otherFees: number;
  };
}

interface StudentFeeRecord {
  id: string;
  studentId: string;
  studentName: string;
  class: string;
  rollNumber: string;
  email: string;
  phone: string;
  academicYear: string;
  feeStructure: FeeStructure;
  payments: Payment[];
  totalPaid: number;
  totalDue: number;
  status: 'Paid' | 'Partial' | 'Overdue' | 'Pending';
}

interface Payment {
  id: string;
  date: string;
  amount: number;
  feeType: FeeType;
  description: string;
  month?: string;
  method: 'Cash' | 'Online' | 'Cheque' | 'Bank Transfer' | 'UPI';
  receiptNumber: string;
  remarks: string;
}

interface ClassFeeSummary {
  className: string;
  totalStudents: number;
  totalCollected: number;
  totalDue: number;
  paidStudents: number;
  pendingStudents: number;
  overdueStudents: number;
}

// Helper function to map API fee types to our FeeType
const mapFeeType = (apiType: string): FeeType => {
  const lowerType = (apiType || '').toLowerCase();
  if (lowerType.includes('admission')) return 'Admission Fee';
  if (lowerType.includes('registration')) return 'Registration Fee';
  if (lowerType.includes('monthly') || lowerType.includes('tuition'))
    return 'Monthly Fee';
  if (lowerType.includes('exam')) return 'Exam Fee';
  return 'Other Fees';
};

export default function FeeManagementERP() {
  // Get orgId from Redux
  const { userData } = useUserDataRedux();
  const orgId = userData?.orgId;

  // Fetch classes using RTK Query
  const { data: classesResponse, isLoading: classesLoading } =
    useGetClassesQuery(orgId!, {
      skip: !orgId,
    });

  // View mode
  const [viewMode, setViewMode] = useState<'student' | 'class' | 'month'>(
    'student',
  );

  // Data states
  const [feeRecords, setFeeRecords] = useState<StudentFeeRecord[]>([]);
  const [allFeeRecords, setAllFeeRecords] = useState<StudentFeeRecord[]>([]);
  const [filteredRecords, setFilteredRecords] = useState<StudentFeeRecord[]>(
    [],
  );
  const [classSummaries, setClassSummaries] = useState<ClassFeeSummary[]>([]);
  const [classes, setClasses] = useState<string[]>([]);
  const [classIdMap, setClassIdMap] = useState<Map<string, string>>(new Map());
  const [feeStructures, setFeeStructures] = useState<FeeStructure[]>([]);

  // Filter states
  const [selectedClass, setSelectedClass] = useState('Select Class');
  const [selectedStatus, setSelectedStatus] = useState('All');
  const [selectedMonth, setSelectedMonth] = useState('All');
  const [selectedYear, setSelectedYear] = useState('2024-25');
  const [searchTerm, setSearchTerm] = useState('');

  // UI states
  const [loading, setLoading] = useState(true);
  const [filterLoading, setFilterLoading] = useState(false);
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [showDetailsModal, setShowDetailsModal] = useState(false);
  const [showFeeStructureModal, setShowFeeStructureModal] = useState(false);
  const [showEditFeeStructureModal, setShowEditFeeStructureModal] =
    useState(false);
  const [showCreateFeeStructureModal, setShowCreateFeeStructureModal] =
    useState(false);
  const [showAssignFeeModal, setShowAssignFeeModal] = useState(false);
  const [showEditPaymentModal, setShowEditPaymentModal] = useState(false);
  const [showDeletePaymentModal, setShowDeletePaymentModal] = useState(false);
  const [selectedRecord, setSelectedRecord] = useState<StudentFeeRecord | null>(
    null,
  );
  const [editingStructure, setEditingStructure] = useState<FeeStructure | null>(
    null,
  );
  const [selectedFeeStructureId, setSelectedFeeStructureId] = useState('');
  const [editingPayment, setEditingPayment] = useState<Payment | null>(null);

  // Create fee structure form state
  const [createFeeStructureData, setCreateFeeStructureData] = useState({
    className: '',
    admissionFee: 0,
    registrationFee: 0,
    tuitionFees: 0,
    examFees: 0,
    otherFees: 0,
  });

  // Payment form states
  const [paymentData, setPaymentData] = useState({
    amount: '',
    feeType: 'Monthly Fee' as FeeType,
    description: '',
    month: '',
    method: 'Cash' as Payment['method'],
    receiptNumber: '',
    remarks: '',
  });

  const router = useRouter();

  const months = [
    'All',
    'April',
    'May',
    'June',
    'July',
    'August',
    'September',
    'October',
    'November',
    'December',
    'January',
    'February',
    'March',
  ];

  const academicYears = ['2024-25'];

  useEffect(() => {
    const tokenStr = localStorage.getItem('bearerToken');
    if (!tokenStr) {
      router.push('/');
      return;
    }
    try {
      const tokenItem = JSON.parse(tokenStr);
      const now = new Date().getTime();
      if (now > tokenItem.expiry) {
        localStorage.removeItem('bearerToken');
        router.push('/');
        return;
      }
    } catch (e) {
      localStorage.removeItem('bearerToken');
      router.push('/');
      return;
    }

    loadFeeData();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [router, selectedYear, orgId, classesResponse]);

  const loadFeeData = async () => {
    try {
      setLoading(true);

      if (!orgId || !classesResponse) {
        console.log('â³ Waiting for orgId or classes data...');
        return;
      }

      // Use classes from RTK Query
      const classNames = classesResponse.data.map(
        (classData) => `${classData.attributes.class}`,
      );

      // Build class ID mapping
      const idMap = new Map<string, string>();
      classesResponse.data.forEach((classData) => {
        idMap.set(classData.attributes.class, classData.id);
      });
      setClassIdMap(idMap);
      setClasses(['Select Class', ...classNames]);

      // Fetch fee structures from API
      const queryString = `?academic_year=${encodeURIComponent(selectedYear)}`;
      const feeStructuresResponse = await makeApiCall({
        path: `/${orgId}/fee-structures${queryString}`,
        method: 'GET',
        baseUrl: 'default',
      }).catch(() => ({ data: [] }));

      // Don't fetch fees for all classes - let handleClassSelection do it per class

      // Create fee structures ONLY from API data (no defaults)
      const structures: FeeStructure[] = (feeStructuresResponse.data || [])
        .map((apiStructure: any) => {
          if (!apiStructure || !apiStructure.attributes.components) {
            return null;
          }

          const components = apiStructure.attributes.components;
          const className = apiStructure.attributes.class_name;

          return {
            id: apiStructure.id,
            className,
            academicYear: apiStructure.attributes.academic_year,
            totalAmount: apiStructure.attributes.total_amount || 0,
            components: {
              admissionFee: components.admission_fee || 0,
              registrationFee: components.registration_fee || 0,
              tuitionFees: components.tuition_fees || 0,
              examFees: components.exam_fees || 0,
              otherFees: components.other_fees || 0,
            },
          };
        })
        .filter((s: FeeStructure | null): s is FeeStructure => s !== null);
      setFeeStructures(structures);

      // Initialize with empty records - will be populated when user selects a class
      setFeeRecords([]);
      setAllFeeRecords([]);
      setFilteredRecords([]);

      // Initialize empty class summaries - will be calculated per class
      const summaries: ClassFeeSummary[] = classNames.map((className) => {
        return {
          className,
          totalStudents: 0,
          totalCollected: 0,
          totalDue: 0,
          paidStudents: 0,
          pendingStudents: 0,
          overdueStudents: 0,
        };
      });
      setClassSummaries(summaries);

      setLoading(false);
    } catch (error) {
      console.error('Error loading fee data:', error);
      setLoading(false);
    }
  };

  // Handle class selection to fetch students by class
  const handleClassSelection = async (className: string) => {
    setSelectedClass(className);

    // If "All" is selected, show all students
    if (className === 'Select Class') {
      setFeeRecords(allFeeRecords);
      return;
    }

    // Get the class ID from the map
    const classId = classIdMap.get(className);
    if (!classId) {
      console.error(`No class ID found for class: ${className}`);
      return;
    }

    try {
      setFilterLoading(true);

      // Fetch students for the selected class
      console.log(
        `ðŸ”µ Fetching fee records for class: ${className} (ID: ${classId})`,
      );
      const classStudentsResponse = await makeApiCall({
        path: `/class/${orgId}/classes/${classId}/students`,
        method: 'GET',
        baseUrl: 'default',
      });

      // Fetch fees for the selected class
      const feeQueryString = `?academic_year=${encodeURIComponent(selectedYear)}`;
      const classFeesResponse = await makeApiCall({
        path: `/${orgId}/classes/${classId}/fees${feeQueryString}`,
        method: 'GET',
        baseUrl: 'default',
      }).catch(() => ({ data: [] }));

      // Find the fee structure for this class
      const structure = feeStructures.find((s) => s.className === className) ||
        feeStructures[0] || {
          id: 'default',
          className,
          academicYear: selectedYear,
          totalAmount: 0,
          components: {
            admissionFee: 0,
            registrationFee: 0,
            tuitionFees: 0,
            examFees: 0,
            otherFees: 0,
          },
        };

      // Create a map of students with assigned fees
      const studentsWithFees = new Map<string, any>();
      (classFeesResponse.data || []).forEach((feeData: any) => {
        const studentId = feeData.attributes.student_id;
        if (studentId) {
          studentsWithFees.set(studentId, feeData);
        }
      });

      // Transform API response to fee records
      const records: StudentFeeRecord[] = classStudentsResponse.data.map(
        (studentData: any) => {
          const studentId = studentData.attributes.student_id || studentData.id;
          const feeData = studentsWithFees.get(studentId);

          if (feeData) {
            // Student has fees assigned
            const attributes = feeData.attributes;
            const payments: Payment[] = (attributes.payments || []).map(
              (payment: any) => ({
                id: payment.id,
                date: payment.date,
                amount: payment.amount,
                feeType: mapFeeType(payment.description || ''),
                description: payment.description,
                month: payment.month,
                method: (payment.method as Payment['method']) || 'Cash',
                receiptNumber: payment.receipt_number,
                remarks: payment.remarks || '',
              }),
            );

            const totalPaid = attributes.total_paid || 0;
            const totalDue =
              attributes.total_due || attributes.remaining_amount || 0;
            const status: StudentFeeRecord['status'] =
              (attributes.status as StudentFeeRecord['status']) ||
              (totalDue === 0 ? 'Paid' : totalPaid > 0 ? 'Partial' : 'Pending');

            // Build fee structure from components
            const feeStructure: FeeStructure = {
              id: attributes.fee_structure_id || structure.id,
              className,
              academicYear: attributes.academic_year || selectedYear,
              totalAmount: attributes.amount || structure.totalAmount,
              components: attributes.components || structure.components,
            };

            return {
              id: feeData.id,
              studentId,
              studentName: `${studentData.attributes.first_name} ${studentData.attributes.last_name}`,
              class: className,
              rollNumber: studentData.attributes.roll_number || studentData.id,
              email: studentData.attributes.email || attributes.email || '',
              phone: studentData.attributes.phone || attributes.phone || '',
              academicYear: selectedYear,
              feeStructure,
              payments,
              totalPaid,
              totalDue,
              status,
            };
          } else {
            // Student does NOT have fees assigned - show with "Not Assigned" status
            return {
              id: `unassigned-${studentId}`,
              studentId,
              studentName: `${studentData.attributes.first_name} ${studentData.attributes.last_name}`,
              class: className,
              rollNumber: studentData.attributes.roll_number || studentData.id,
              email: studentData.attributes.email,
              phone: studentData.attributes.phone,
              academicYear: selectedYear,
              feeStructure: structure,
              payments: [],
              totalPaid: 0,
              totalDue: 0,
              status: 'Pending' as StudentFeeRecord['status'], // We'll show "Not Assigned" in UI
            };
          }
        },
      );

      console.log(
        `âœ… Loaded ${records.length} fee records for class ${className}`,
      );
      setFeeRecords(records);
    } catch (error) {
      console.error('Error loading class fee records:', error);
      setFeeRecords([]);
    } finally {
      setFilterLoading(false);
    }
  };

  // Apply filters (status, month, search - class is handled by handleClassSelection)
  useEffect(() => {
    let filtered = feeRecords;

    if (selectedStatus !== 'All') {
      filtered = filtered.filter((r) => r.status === selectedStatus);
    }

    if (selectedMonth !== 'All') {
      filtered = filtered.filter((r) =>
        r.payments.some((p) => p.month === selectedMonth),
      );
    }

    if (searchTerm) {
      filtered = filtered.filter(
        (r) =>
          r.studentName.toLowerCase().includes(searchTerm.toLowerCase()) ||
          r.rollNumber.includes(searchTerm) ||
          r.studentId.includes(searchTerm),
      );
    }

    setFilteredRecords(filtered);
  }, [selectedClass, selectedStatus, selectedMonth, searchTerm, feeRecords]);

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'Paid':
        return 'bg-green-100 text-green-800';
      case 'Partial':
        return 'bg-yellow-100 text-yellow-800';
      case 'Overdue':
        return 'bg-red-100 text-red-800';
      case 'Pending':
        return 'bg-gray-100 text-gray-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };

  const handlePayment = (record: StudentFeeRecord) => {
    setSelectedRecord(record);
    setPaymentData({
      amount: '',
      feeType: 'Monthly Fee',
      description: '',
      month: '',
      method: 'Cash',
      receiptNumber: `RCP-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`,
      remarks: '',
    });
    setShowPaymentModal(true);
  };

  const submitPayment = async () => {
    if (!selectedRecord || !paymentData.amount) return;

    try {
      const orgId = await ApiService.getCurrentOrgId();

      // We need the fee_id to record payment
      const feeId = selectedRecord.id;
      console.log('Recording payment for:', {
        orgId,
        feeId,
        studentName: selectedRecord.studentName,
        studentId: selectedRecord.studentId,
      });

      // Prepare payment data for API
      // Format date as DD/MM/YYYY
      const today = new Date();
      const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;

      const paymentApiData = {
        amount: parseFloat(paymentData.amount),
        date: formattedDate,
        receipt_number: paymentData.receiptNumber,
        method: paymentData.method,
        description: paymentData.description || paymentData.feeType,
        month: paymentData.month || '',
        remarks: paymentData.remarks,
      };

      // Call API to record payment
      await ApiService.recordPayment(orgId, feeId, paymentApiData);

      alert(
        `Payment of â‚¹${paymentData.amount} recorded successfully for ${selectedRecord.studentName}`,
      );
      setShowPaymentModal(false);

      // Reload fee data to show updated information
      loadFeeData();
    } catch (error) {
      console.error('Error recording payment:', error);
      alert('Failed to record payment. Please try again.');
    }
  };

  const sendReminder = (record: StudentFeeRecord) => {
    alert(`Payment reminder sent to ${record.studentName} (${record.email})`);
  };

  // Create fee structure handler
  const handleCreateFeeStructure = async () => {
    try {
      if (!createFeeStructureData.className) {
        alert('Please select a class');
        return;
      }

      setLoading(true);
      const orgId = await ApiService.getCurrentOrgId();
      const classId = classIdMap.get(createFeeStructureData.className);

      if (!classId) {
        alert('Invalid class selected');
        setLoading(false);
        return;
      }

      await ApiService.createFeeStructure(orgId, classId, {
        class_name: createFeeStructureData.className,
        academic_year: selectedYear,
        components: {
          admission_fee: createFeeStructureData.admissionFee,
          registration_fee: createFeeStructureData.registrationFee,
          tuition_fees: createFeeStructureData.tuitionFees,
          exam_fees: createFeeStructureData.examFees,
          other_fees: createFeeStructureData.otherFees,
        },
      });

      alert('Fee structure created successfully!');
      setShowCreateFeeStructureModal(false);
      setCreateFeeStructureData({
        className: '',
        admissionFee: 0,
        registrationFee: 0,
        tuitionFees: 0,
        examFees: 0,
        otherFees: 0,
      });

      // Reload fee data
      await loadFeeData();
      setLoading(false);
    } catch (error) {
      console.error('Error creating fee structure:', error);
      alert('Failed to create fee structure. Please try again.');
      setLoading(false);
    }
  };

  // Delete fee structure handler
  const handleDeleteFeeStructure = async (
    structureId: string,
    className: string,
  ) => {
    if (
      !confirm(
        `Are you sure you want to delete the fee structure for ${className}?`,
      )
    ) {
      return;
    }

    try {
      setLoading(true);
      const orgId = await ApiService.getCurrentOrgId();
      await ApiService.deleteFeeStructure(orgId, structureId);

      alert('Fee structure deleted successfully!');

      // Reload fee data
      await loadFeeData();
      setLoading(false);
    } catch (error) {
      console.error('Error deleting fee structure:', error);
      alert('Failed to delete fee structure. Please try again.');
      setLoading(false);
    }
  };

  // Calculate overall statistics
  const totalCollected = feeRecords.reduce((sum, r) => sum + r.totalPaid, 0);
  const totalDue = feeRecords.reduce((sum, r) => sum + r.totalDue, 0);
  const totalExpected = totalCollected + totalDue;
  const collectionPercentage =
    totalExpected > 0 ? (totalCollected / totalExpected) * 100 : 0;
  const paidCount = feeRecords.filter((r) => r.status === 'Paid').length;
  const overdueCount = feeRecords.filter((r) => r.status === 'Overdue').length;

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading fee management system...</p>
        </div>
      </div>
    );
  }

  // Show loading state while classes are being fetched
  if (classesLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="flex flex-col items-center space-y-4">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
          <p className="text-gray-600">Loading fee management...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-4">
            <div className="flex items-center">
              <Link
                href="/admin-portal/dashboard"
                className="text-gray-500 hover:text-gray-700 mr-4"
              >
                <svg
                  className="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M10 19l-7-7m0 0l7-7m-7 7h18"
                  />
                </svg>
              </Link>
              <h1 className="text-xl font-semibold text-gray-900">
                Fee Management System
              </h1>
            </div>
            <div className="flex items-center space-x-3">
              <select
                value={selectedYear}
                onChange={(e) => setSelectedYear(e.target.value)}
                className="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              >
                {academicYears.map((year) => (
                  <option key={year} value={year}>
                    A.Y. {year}
                  </option>
                ))}
              </select>
              <button
                onClick={() => setShowFeeStructureModal(true)}
                className="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-200 transition-colors"
              >
                Fee Structure
              </button>
              <button
                onClick={() => window.print()}
                className="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 transition-colors"
              >
                Export Report
              </button>
            </div>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        {/* Statistics Dashboard */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm font-medium text-gray-600">
                Total Collected
              </p>
              <div className="bg-green-100 p-2 rounded-lg">
                <svg
                  className="w-5 h-5 text-green-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
            </div>
            <p className="text-2xl font-bold text-gray-900">
              â‚¹{totalCollected.toLocaleString()}
            </p>
            <p className="text-sm text-green-600 mt-1">
              {collectionPercentage.toFixed(1)}% of total
            </p>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm font-medium text-gray-600">Total Due</p>
              <div className="bg-red-100 p-2 rounded-lg">
                <svg
                  className="w-5 h-5 text-red-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
            </div>
            <p className="text-2xl font-bold text-gray-900">
              â‚¹{totalDue.toLocaleString()}
            </p>
            <p className="text-sm text-gray-600 mt-1">Pending collection</p>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm font-medium text-gray-600">Fully Paid</p>
              <div className="bg-blue-100 p-2 rounded-lg">
                <svg
                  className="w-5 h-5 text-blue-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
            </div>
            <p className="text-2xl font-bold text-gray-900">{paidCount}</p>
            <p className="text-sm text-gray-600 mt-1">Students paid in full</p>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm font-medium text-gray-600">
                Overdue Alerts
              </p>
              <div className="bg-orange-100 p-2 rounded-lg">
                <svg
                  className="w-5 h-5 text-orange-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  />
                </svg>
              </div>
            </div>
            <p className="text-2xl font-bold text-gray-900">{overdueCount}</p>
            <p className="text-sm text-gray-600 mt-1">Need follow-up</p>
          </div>
        </div>

        {/* View Mode Tabs */}
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
          <div className="border-b border-gray-200">
            <nav className="flex -mb-px">
              <button
                onClick={() => setViewMode('student')}
                className={`px-6 py-3 text-sm font-medium border-b-2 ${
                  viewMode === 'student'
                    ? 'border-indigo-600 text-indigo-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                Student-wise View
              </button>
              {/* <button
                onClick={() => setViewMode('class')}
                className={`px-6 py-3 text-sm font-medium border-b-2 ${
                  viewMode === 'class'
                    ? 'border-indigo-600 text-indigo-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                Class-wise Summary
              </button>
              <button
                onClick={() => setViewMode('month')}
                className={`px-6 py-3 text-sm font-medium border-b-2 ${
                  viewMode === 'month'
                    ? 'border-indigo-600 text-indigo-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                Month-wise Collection
              </button> */}
            </nav>
          </div>

          {/* Filters */}
          <div className="p-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Filter by Class
                </label>
                <select
                  value={selectedClass}
                  onChange={(e) => handleClassSelection(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                >
                  {classes.map((cls) => (
                    <option key={cls} value={cls}>
                      {cls}
                    </option>
                  ))}
                </select>
              </div>

              {/* <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Filter by Status
                </label>
                <select
                  value={selectedStatus}
                  onChange={(e) => setSelectedStatus(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                >
                  <option value="All">All Status</option>
                  <option value="Paid">Paid</option>
                  <option value="Partial">Partial</option>
                  <option value="Pending">Pending</option>
                  <option value="Overdue">Overdue</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Filter by Month
                </label>
                <select
                  value={selectedMonth}
                  onChange={(e) => setSelectedMonth(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                >
                  {months.map((month) => (
                    <option key={month} value={month}>
                      {month}
                    </option>
                  ))}
                </select>
              </div> */}

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Search
                </label>
                <input
                  type="text"
                  placeholder="Name, Roll No..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                />
              </div>
            </div>
          </div>
        </div>

        {/* Subtle Loading Indicator */}
        {filterLoading && (
          <div className="mb-4 flex items-center justify-center py-2">
            <div className="flex items-center space-x-2 text-indigo-600">
              <svg
                className="animate-spin h-4 w-4"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  className="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  strokeWidth="4"
                ></circle>
                <path
                  className="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span className="text-sm font-medium">
                Loading fee records...
              </span>
            </div>
          </div>
        )}

        {/* Content based on view mode */}
        {viewMode === 'student' && (
          <div
            className={`bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden transition-opacity duration-200 ${filterLoading ? 'opacity-50' : 'opacity-100'}`}
          >
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Student
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Class
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Total Fee
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Paid
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Due
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Status
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredRecords.map((record) => (
                    <tr key={record.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4">
                        <div className="text-sm font-medium text-gray-900">
                          {record.studentName}
                        </div>
                        <div className="text-sm text-gray-500">
                          Roll: {record.rollNumber}
                        </div>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        {record.class}
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-900">
                        â‚¹
                        {record.feeStructure?.totalAmount?.toLocaleString() ||
                          '0'}
                      </td>
                      <td className="px-6 py-4 text-sm text-green-600 font-medium">
                        â‚¹{record.totalPaid?.toLocaleString() || '0'}
                      </td>
                      <td className="px-6 py-4 text-sm text-red-600 font-medium">
                        â‚¹{record.totalDue?.toLocaleString() || '0'}
                      </td>
                      <td className="px-6 py-4">
                        <span
                          className={`px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(record.status)}`}
                        >
                          {record.status}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-sm space-x-2">
                        {record.id.startsWith('unassigned-') ? (
                          // Student has NO fees assigned - show Assign Fee button
                          <button
                            onClick={() => {
                              setSelectedRecord(record);
                              setShowAssignFeeModal(true);
                            }}
                            className="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium"
                          >
                            Assign Fee
                          </button>
                        ) : (
                          <>
                            <button
                              onClick={async () => {
                                try {
                                  // Fetch student fees from API
                                  const orgId =
                                    await ApiService.getCurrentOrgId();
                                  const studentFeesResponse =
                                    await ApiService.getStudentFees(
                                      orgId,
                                      record.studentId,
                                      {
                                        academic_year: selectedYear,
                                      },
                                    );

                                  // Update the record with fresh data from API
                                  const updatedRecord = { ...record };

                                  // Process the API response to update payments and fee details
                                  if (
                                    studentFeesResponse.data &&
                                    studentFeesResponse.data.length > 0
                                  ) {
                                    const feeData = studentFeesResponse.data[0];
                                    const attributes = feeData.attributes;

                                    // Update payment information
                                    updatedRecord.totalPaid =
                                      attributes.amount_paid || 0;
                                    updatedRecord.totalDue =
                                      attributes.amount_due || 0;

                                    // Update status based on API response
                                    const status =
                                      attributes.payment_status?.toLowerCase();
                                    if (
                                      status === 'completed' ||
                                      status === 'paid'
                                    ) {
                                      updatedRecord.status = 'Paid';
                                    } else if (status === 'partial') {
                                      updatedRecord.status = 'Partial';
                                    } else if (status === 'overdue') {
                                      updatedRecord.status = 'Overdue';
                                    } else {
                                      updatedRecord.status = 'Pending';
                                    }

                                    // Update payments array if available
                                    if (
                                      attributes.payments &&
                                      Array.isArray(attributes.payments)
                                    ) {
                                      updatedRecord.payments =
                                        attributes.payments.map(
                                          (p: any, idx: number) => ({
                                            id: p.id || `payment-${idx}`,
                                            date:
                                              p.date ||
                                              p.payment_date ||
                                              new Date()
                                                .toISOString()
                                                .split('T')[0],
                                            amount: p.amount || 0,
                                            feeType: mapFeeType(
                                              p.description || p.fee_type || '',
                                            ),
                                            description: p.description || '',
                                            month: p.month || '',
                                            method: (p.method ||
                                              p.payment_method ||
                                              'Cash') as Payment['method'],
                                            receiptNumber:
                                              p.receipt_number ||
                                              `RCP-${idx + 1}`,
                                            remarks: p.remarks || '',
                                          }),
                                        );
                                    }
                                  }

                                  setSelectedRecord(updatedRecord);
                                  setShowDetailsModal(true);
                                } catch (error) {
                                  console.error(
                                    'Error fetching student fees:',
                                    error,
                                  );
                                  // Fall back to showing existing record data
                                  setSelectedRecord(record);
                                  setShowDetailsModal(true);
                                }
                              }}
                              className="text-indigo-600 hover:text-indigo-900 font-medium"
                            >
                              View
                            </button>
                            {record.status !== 'Paid' && (
                              <>
                                <button
                                  onClick={() => handlePayment(record)}
                                  className="text-green-600 hover:text-green-900 font-medium"
                                >
                                  Pay
                                </button>
                              </>
                            )}
                          </>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            {filteredRecords.length === 0 && (
              <div className="text-center py-12">
                <p className="text-gray-500">No records found</p>
              </div>
            )}
          </div>
        )}

        {viewMode === 'class' && (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {classSummaries
              .filter(
                (s) => selectedClass === 'All' || s.className === selectedClass,
              )
              .map((summary) => (
                <div
                  key={summary.className}
                  className="bg-white rounded-lg shadow-sm border border-gray-200 p-6"
                >
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">
                    {summary.className}
                  </h3>
                  <div className="space-y-3">
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">
                        Total Students:
                      </span>
                      <span className="text-sm font-semibold">
                        {summary.totalStudents}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">Collected:</span>
                      <span className="text-sm font-semibold text-green-600">
                        â‚¹{summary.totalCollected.toLocaleString()}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">Due:</span>
                      <span className="text-sm font-semibold text-red-600">
                        â‚¹{summary.totalDue.toLocaleString()}
                      </span>
                    </div>
                    <div className="pt-3 border-t border-gray-200">
                      <div className="flex justify-between text-xs">
                        <span className="text-green-600">
                          Paid: {summary.paidStudents}
                        </span>
                        <span className="text-gray-600">
                          Pending: {summary.pendingStudents}
                        </span>
                        <span className="text-red-600">
                          Overdue: {summary.overdueStudents}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
          </div>
        )}

        {viewMode === 'month' && (
          <div className="bg-white shadow-sm rounded-lg border border-gray-200 p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">
              Month-wise Collection Report
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {months.slice(1).map((month) => {
                const monthPayments = feeRecords.flatMap((r) =>
                  r.payments.filter((p) => p.month === month),
                );
                const monthTotal = monthPayments.reduce(
                  (sum, p) => sum + p.amount,
                  0,
                );
                const monthCount = monthPayments.length;

                return (
                  <div
                    key={month}
                    className="border border-gray-200 rounded-lg p-4"
                  >
                    <h4 className="font-semibold text-gray-900 mb-2">
                      {month}
                    </h4>
                    <p className="text-2xl font-bold text-green-600">
                      â‚¹{monthTotal.toLocaleString()}
                    </p>
                    <p className="text-sm text-gray-600 mt-1">
                      {monthCount} transactions
                    </p>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </main>

      {/* Payment Modal */}
      {showPaymentModal && selectedRecord && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-lg p-8 max-w-md w-full my-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <h2 className="text-2xl font-bold text-gray-900 mb-6">
              Record Payment
            </h2>

            <div className="mb-4">
              <p className="text-sm text-gray-600">Student</p>
              <p className="text-lg font-semibold">
                {selectedRecord.studentName} ({selectedRecord.class})
              </p>
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Fee Type <span className="text-red-500">*</span>
              </label>
              <select
                value={paymentData.feeType}
                onChange={(e) => {
                  const feeType = e.target.value as FeeType;
                  let amount = '';
                  let description = '';
                  const month = '';

                  // Auto-fill amount based on fee type
                  if (feeType === 'Admission Fee') {
                    amount =
                      selectedRecord.feeStructure?.components?.admissionFee?.toString() ||
                      '0';
                    description = 'Admission Fee';
                  } else if (feeType === 'Registration Fee') {
                    amount =
                      selectedRecord.feeStructure?.components?.registrationFee?.toString() ||
                      '0';
                    description = 'Registration Fee';
                  } else if (feeType === 'Monthly Fee') {
                    amount = (
                      (selectedRecord.feeStructure?.components?.tuitionFees ||
                        0) / 12
                    ).toFixed(2);
                    description = 'Tuition Fee (Monthly)';
                  } else if (feeType === 'Exam Fee') {
                    amount =
                      selectedRecord.feeStructure?.components?.examFees?.toString() ||
                      '0';
                    description = 'Exam Fee';
                  } else if (feeType === 'Other Fees') {
                    amount =
                      selectedRecord.feeStructure?.components?.otherFees?.toString() ||
                      '0';
                    description = 'Other Fees';
                  }

                  setPaymentData({
                    ...paymentData,
                    feeType,
                    amount,
                    description,
                    month,
                  });
                }}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              >
                <option value="Monthly Fee">Monthly Fee</option>
                <option value="Exam Fee">Exam Fee</option>
                <option value="Registration Fee">Registration Fee</option>
                <option value="Admission Fee">Admission Fee</option>
                <option value="Other Fees">Other Fees</option>
              </select>
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Description
              </label>
              <input
                type="text"
                value={paymentData.description}
                onChange={(e) =>
                  setPaymentData({
                    ...paymentData,
                    description: e.target.value,
                  })
                }
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="Payment description"
              />
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Amount <span className="text-red-500">*</span>
              </label>
              <input
                type="number"
                value={paymentData.amount}
                onChange={(e) =>
                  setPaymentData({ ...paymentData, amount: e.target.value })
                }
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="Enter amount"
              />
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Payment Method
              </label>
              <select
                value={paymentData.method}
                onChange={(e) =>
                  setPaymentData({
                    ...paymentData,
                    method: e.target.value as Payment['method'],
                  })
                }
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              >
                <option value="Cash">Cash</option>
                <option value="Online">Online Transfer</option>
                <option value="UPI">UPI</option>
                <option value="Cheque">Cheque</option>
                <option value="Bank Transfer">Bank Transfer</option>
              </select>
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Receipt Number
              </label>
              <input
                type="text"
                value={paymentData.receiptNumber}
                onChange={(e) =>
                  setPaymentData({
                    ...paymentData,
                    receiptNumber: e.target.value,
                  })
                }
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>

            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Remarks
              </label>
              <textarea
                value={paymentData.remarks}
                onChange={(e) =>
                  setPaymentData({ ...paymentData, remarks: e.target.value })
                }
                rows={3}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>

            <div className="flex space-x-3">
              <button
                onClick={submitPayment}
                className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium"
              >
                Record Payment
              </button>
              <button
                onClick={() => setShowPaymentModal(false)}
                className="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 font-medium"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Details Modal */}
      {showDetailsModal && selectedRecord && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-lg p-8 max-w-3xl w-full my-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <h2 className="text-2xl font-bold text-gray-900 mb-6">
              Fee Details - {selectedRecord.studentName}
            </h2>

            {/* Student Info */}
            <div className="bg-gray-50 rounded-lg p-4 mb-6 grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-600">Roll Number</p>
                <p className="font-semibold text-gray-900">
                  {selectedRecord.rollNumber}
                </p>
              </div>
              <div>
                <p className="text-sm text-gray-600">Class</p>
                <p className="font-semibold text-gray-900">
                  {selectedRecord.class}
                </p>
              </div>
              <div>
                <p className="text-sm text-gray-600">Email</p>
                <p className="font-semibold text-gray-900">
                  {selectedRecord.email}
                </p>
              </div>
              <div>
                <p className="text-sm text-gray-600">Phone</p>
                <p className="font-semibold text-gray-900">
                  {selectedRecord.phone}
                </p>
              </div>
            </div>

            {/* Fee Summary */}
            <div className="bg-gray-50 rounded-lg p-4 mb-6">
              <h3 className="font-semibold text-lg text-gray-900 mb-3">
                Fee Summary
              </h3>
              <div className="space-y-2">
                <div className="flex justify-between">
                  <span className="text-gray-700">Total Fee:</span>
                  <span className="font-semibold text-gray-900">
                    â‚¹
                    {selectedRecord.feeStructure?.totalAmount?.toLocaleString() ||
                      '0'}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-700">Paid Amount:</span>
                  <span className="font-semibold text-green-600">
                    â‚¹{selectedRecord.totalPaid?.toLocaleString() || '0'}
                  </span>
                </div>
                <div className="flex justify-between border-t pt-2">
                  <span className="text-gray-700">Due Amount:</span>
                  <span className="font-semibold text-red-600">
                    â‚¹{selectedRecord.totalDue?.toLocaleString() || '0'}
                  </span>
                </div>
              </div>
            </div>

            {/* Fee Components Breakdown */}
            <div className="mb-6">
              <h3 className="font-semibold text-lg text-gray-900 mb-3">
                Fee Components Status
              </h3>
              <div className="space-y-4">
                {/* Admission Fee */}
                <div className="border-b pb-3">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="font-medium text-gray-900">Admission Fee</p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-gray-900">
                        â‚¹
                        {selectedRecord.feeStructure?.components?.admissionFee?.toLocaleString() ||
                          '0'}
                      </p>
                      <span
                        className={`text-xs px-2 py-1 rounded-full ${selectedRecord.payments?.some((p) => p.feeType === 'Admission Fee') ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}
                      >
                        {selectedRecord.payments?.some(
                          (p) => p.feeType === 'Admission Fee',
                        )
                          ? 'Paid'
                          : 'Pending'}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Registration Fee */}
                <div className="border-b pb-3">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="font-medium text-gray-900">
                        Registration Fee
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-gray-900">
                        â‚¹
                        {selectedRecord.feeStructure?.components?.registrationFee?.toLocaleString() ||
                          '0'}
                      </p>
                      <span
                        className={`text-xs px-2 py-1 rounded-full ${selectedRecord.payments?.some((p) => p.feeType === 'Registration Fee') ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}
                      >
                        {selectedRecord.payments?.some(
                          (p) => p.feeType === 'Registration Fee',
                        )
                          ? 'Paid'
                          : 'Pending'}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Tuition Fees */}
                <div className="border-b pb-3">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="font-medium text-gray-900">
                        Tuition Fees (Annual)
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-gray-900">
                        â‚¹
                        {selectedRecord.feeStructure?.components?.tuitionFees?.toLocaleString() ||
                          '0'}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Exam Fees */}
                <div className="border-b pb-3">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="font-medium text-gray-900">Exam Fees</p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-gray-900">
                        â‚¹
                        {selectedRecord.feeStructure?.components?.examFees?.toLocaleString() ||
                          '0'}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Other Fees */}
                <div>
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="font-medium text-gray-900">Other Fees</p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-gray-900">
                        â‚¹
                        {selectedRecord.feeStructure?.components?.otherFees?.toLocaleString() ||
                          '0'}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Payment History */}
            <div className="mb-6">
              <h3 className="font-semibold text-lg text-gray-900 mb-3">
                Payment History
              </h3>
              {selectedRecord.payments.length > 0 ? (
                <div className="space-y-3">
                  {selectedRecord.payments.map((payment) => (
                    <div key={payment.id} className="border rounded-lg p-4">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <p className="font-semibold text-green-600">
                            â‚¹{payment.amount.toLocaleString()}
                          </p>
                          <p className="text-sm text-gray-600">
                            {payment.date}
                            {payment.month ? ` - ${payment.month}` : ''}
                          </p>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                          <span className="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded font-medium">
                            {payment.feeType}
                          </span>
                          <span className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
                            {payment.method}
                          </span>
                        </div>
                      </div>
                      <p className="text-sm text-gray-700 font-medium">
                        {payment.description}
                      </p>
                      <p className="text-sm text-gray-500">
                        Receipt: {payment.receiptNumber}
                      </p>
                      {payment.remarks && (
                        <p className="text-sm text-gray-500 mt-1">
                          Remarks: {payment.remarks}
                        </p>
                      )}
                      <div className="flex gap-2 mt-3 pt-3 border-t">
                        <button
                          onClick={() => {
                            setEditingPayment(payment);
                            setShowEditPaymentModal(true);
                          }}
                          className="text-sm text-indigo-600 hover:text-indigo-900 font-medium"
                        >
                          Edit
                        </button>
                        <button
                          onClick={() => {
                            setEditingPayment(payment);
                            setShowDeletePaymentModal(true);
                          }}
                          className="text-sm text-red-600 hover:text-red-900 font-medium"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-500 text-center py-4">
                  No payments recorded yet
                </p>
              )}
            </div>

            <button
              onClick={() => setShowDetailsModal(false)}
              className="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 font-medium"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Fee Structure Modal */}
      {showFeeStructureModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-lg p-8 max-w-4xl w-full my-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-gray-900">
                Fee Structure - Academic Year {selectedYear}
              </h2>
              <button
                onClick={() => setShowCreateFeeStructureModal(true)}
                className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-medium"
              >
                + Create New
              </button>
            </div>

            {feeStructures.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <p className="text-lg mb-2">No fee structures found</p>
                <p className="text-sm">
                  Click &quot;Create New&quot; to add a fee structure
                </p>
              </div>
            ) : null}

            {feeStructures.map((structure) => (
              <div
                key={structure.id}
                className="mb-6 border border-gray-200 rounded-lg p-4"
              >
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold text-gray-900">
                    {structure.className}
                  </h3>
                  <div className="flex items-center gap-3">
                    <p className="text-xl font-bold text-indigo-600">
                      â‚¹{structure.totalAmount.toLocaleString()}
                    </p>
                    <button
                      onClick={() => {
                        setEditingStructure(structure);
                        setShowEditFeeStructureModal(true);
                      }}
                      className="px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700"
                    >
                      Edit
                    </button>
                    <button
                      onClick={() =>
                        handleDeleteFeeStructure(
                          structure.id,
                          structure.className,
                        )
                      }
                      className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700"
                    >
                      Delete
                    </button>
                  </div>
                </div>
                <div className="space-y-3">
                  {/* Admission & Registration */}
                  <div className="flex justify-between items-center p-2 bg-blue-50 rounded">
                    <p className="font-medium text-blue-900">Admission Fee</p>
                    <p className="font-semibold text-blue-900">
                      â‚¹{structure.components.admissionFee.toLocaleString()}
                    </p>
                  </div>
                  <div className="flex justify-between items-center p-2 bg-blue-50 rounded">
                    <p className="font-medium text-blue-900">
                      Registration Fee
                    </p>
                    <p className="font-semibold text-blue-900">
                      â‚¹{structure.components.registrationFee.toLocaleString()}
                    </p>
                  </div>

                  {/* Tuition Fees */}
                  <div className="flex justify-between items-center p-2 bg-green-50 rounded">
                    <p className="font-medium text-green-900">
                      Tuition Fees (Annual)
                    </p>
                    <p className="font-semibold text-green-900">
                      â‚¹{structure.components.tuitionFees.toLocaleString()}
                    </p>
                  </div>

                  {/* Exam Fees */}
                  <div className="flex justify-between items-center p-2 bg-yellow-50 rounded">
                    <p className="font-medium text-yellow-900">Exam Fees</p>
                    <p className="font-semibold text-yellow-900">
                      â‚¹{structure.components.examFees.toLocaleString()}
                    </p>
                  </div>

                  {/* Other Fees */}
                  <div className="flex justify-between items-center p-2 bg-purple-50 rounded">
                    <p className="font-medium text-purple-900">Other Fees</p>
                    <p className="font-semibold text-purple-900">
                      â‚¹{structure.components.otherFees.toLocaleString()}
                    </p>
                  </div>
                </div>
              </div>
            ))}

            <button
              onClick={() => setShowFeeStructureModal(false)}
              className="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Edit Fee Structure Modal */}
      {showEditFeeStructureModal && editingStructure && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-lg p-8 max-w-2xl w-full my-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <h2 className="text-2xl font-bold text-gray-900 mb-6">
              Edit Fee Structure - {editingStructure.className}
            </h2>

            <div className="space-y-6">
              {/* Admission Fee */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Admission Fee
                </label>
                <input
                  type="number"
                  value={editingStructure.components.admissionFee}
                  onChange={(e) => {
                    const newStructure = {
                      ...editingStructure,
                      components: {
                        ...editingStructure.components,
                        admissionFee: parseInt(e.target.value) || 0,
                      },
                    };
                    setEditingStructure(newStructure);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                  placeholder="Enter admission fee"
                />
              </div>

              {/* Registration Fee */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Registration Fee
                </label>
                <input
                  type="number"
                  value={editingStructure.components.registrationFee}
                  onChange={(e) => {
                    const newStructure = {
                      ...editingStructure,
                      components: {
                        ...editingStructure.components,
                        registrationFee: parseInt(e.target.value) || 0,
                      },
                    };
                    setEditingStructure(newStructure);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                  placeholder="Enter registration fee"
                />
              </div>

              {/* Tuition Fees */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Tuition Fees (Annual)
                </label>
                <input
                  type="number"
                  value={editingStructure.components.tuitionFees}
                  onChange={(e) => {
                    const newStructure = {
                      ...editingStructure,
                      components: {
                        ...editingStructure.components,
                        tuitionFees: parseInt(e.target.value) || 0,
                      },
                    };
                    setEditingStructure(newStructure);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                  placeholder="Enter annual tuition fee"
                />
              </div>

              {/* Exam Fees */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Exam Fees
                </label>
                <input
                  type="number"
                  value={editingStructure.components.examFees}
                  onChange={(e) => {
                    const newStructure = {
                      ...editingStructure,
                      components: {
                        ...editingStructure.components,
                        examFees: parseInt(e.target.value) || 0,
                      },
                    };
                    setEditingStructure(newStructure);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                  placeholder="Enter exam fees"
                />
              </div>

              {/* Other Fees */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Other Fees
                </label>
                <input
                  type="number"
                  value={editingStructure.components.otherFees}
                  onChange={(e) => {
                    const newStructure = {
                      ...editingStructure,
                      components: {
                        ...editingStructure.components,
                        otherFees: parseInt(e.target.value) || 0,
                      },
                    };
                    setEditingStructure(newStructure);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                  placeholder="Enter other fees"
                />
              </div>

              {/* Total Calculation */}
              <div className="bg-indigo-50 rounded-lg p-4">
                <div className="flex justify-between items-center">
                  <span className="text-lg font-semibold text-gray-900">
                    New Total Amount:
                  </span>
                  <span className="text-2xl font-bold text-indigo-600">
                    â‚¹
                    {(
                      editingStructure.components.admissionFee +
                      editingStructure.components.registrationFee +
                      editingStructure.components.tuitionFees +
                      editingStructure.components.examFees +
                      editingStructure.components.otherFees
                    ).toLocaleString()}
                  </span>
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex gap-3 mt-6">
              <button
                onClick={async () => {
                  try {
                    // Calculate new total
                    const newTotal =
                      editingStructure.components.admissionFee +
                      editingStructure.components.registrationFee +
                      editingStructure.components.tuitionFees +
                      editingStructure.components.examFees +
                      editingStructure.components.otherFees;

                    // Get orgId and classId
                    const orgId = await ApiService.getCurrentOrgId();
                    const classId =
                      classIdMap.get(editingStructure.className) ||
                      editingStructure.className
                        .toLowerCase()
                        .replace(/\s+/g, '-');

                    // Prepare API payload
                    const feeStructureData = {
                      class_name: editingStructure.className,
                      academic_year: editingStructure.academicYear,
                      components: {
                        admission_fee: editingStructure.components.admissionFee,
                        registration_fee:
                          editingStructure.components.registrationFee,
                        tuition_fees: editingStructure.components.tuitionFees,
                        exam_fees: editingStructure.components.examFees,
                        other_fees: editingStructure.components.otherFees,
                      },
                    };

                    // Call API to update fee structure
                    if (editingStructure.id.startsWith('struct-')) {
                      await ApiService.createFeeStructure(
                        orgId,
                        classId,
                        feeStructureData,
                      );
                    } else {
                      await ApiService.updateFeeStructure(
                        orgId,
                        editingStructure.id,
                        feeStructureData,
                      );
                    }
                    alert('Fee structure updated successfully!');

                    // Update the fee structure in the state
                    const updatedStructures = feeStructures.map((s) =>
                      s.id === editingStructure.id
                        ? { ...editingStructure, totalAmount: newTotal }
                        : s,
                    );
                    setFeeStructures(updatedStructures);

                    // Update all fee records with this class to use the new structure
                    const updatedRecords = allFeeRecords.map((record) => {
                      if (record.class === editingStructure.className) {
                        const newDue = newTotal - record.totalPaid;
                        return {
                          ...record,
                          feeStructure: {
                            ...editingStructure,
                            totalAmount: newTotal,
                          },
                          totalDue: newDue,
                          status:
                            record.totalPaid >= newTotal
                              ? 'Paid'
                              : record.totalPaid > 0
                                ? 'Partial'
                                : ('Pending' as
                                    | 'Paid'
                                    | 'Partial'
                                    | 'Overdue'
                                    | 'Pending'),
                        };
                      }
                      return record;
                    });
                    setAllFeeRecords(updatedRecords);
                    setFeeRecords(updatedRecords);
                    setFilteredRecords(updatedRecords);

                    // Close modal
                    setShowEditFeeStructureModal(false);
                    setEditingStructure(null);

                    // Reload data to get fresh API data
                    loadFeeData();
                  } catch (error) {
                    console.error('Error saving fee structure:', error);
                    alert('Failed to save fee structure. Please try again.');
                  }
                }}
                className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium"
              >
                Save Changes
              </button>
              <button
                onClick={() => {
                  setShowEditFeeStructureModal(false);
                  setEditingStructure(null);
                }}
                className="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 font-medium"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Create Fee Structure Modal */}
      {showCreateFeeStructureModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
          <div className="bg-white rounded-lg p-8 max-w-2xl w-full my-8 max-h-[calc(100vh-4rem)] overflow-y-auto">
            <h2 className="text-2xl font-bold text-gray-900 mb-6">
              Create New Fee Structure
            </h2>

            <div className="space-y-6">
              {/* Class Selection */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Select Class *
                </label>
                <select
                  value={createFeeStructureData.className}
                  onChange={(e) =>
                    setCreateFeeStructureData({
                      ...createFeeStructureData,
                      className: e.target.value,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                >
                  <option value="">Choose a class...</option>
                  {classes
                    .filter((c) => c !== 'All')
                    .filter(
                      (c) => !feeStructures.find((s) => s.className === c),
                    )
                    .map((className) => (
                      <option key={className} value={className}>
                        {className}
                      </option>
                    ))}
                </select>
              </div>

              {/* Admission Fee */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Admission Fee (â‚¹)
                </label>
                <input
                  type="number"
                  value={createFeeStructureData.admissionFee}
                  onChange={(e) =>
                    setCreateFeeStructureData({
                      ...createFeeStructureData,
                      admissionFee: parseFloat(e.target.value) || 0,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>

              {/* Registration Fee */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Registration Fee (â‚¹)
                </label>
                <input
                  type="number"
                  value={createFeeStructureData.registrationFee}
                  onChange={(e) =>
                    setCreateFeeStructureData({
                      ...createFeeStructureData,
                      registrationFee: parseFloat(e.target.value) || 0,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>

              {/* Tuition Fees */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Total Tuition Fees (â‚¹) - Annual
                </label>
                <input
                  type="number"
                  value={createFeeStructureData.tuitionFees}
                  onChange={(e) =>
                    setCreateFeeStructureData({
                      ...createFeeStructureData,
                      tuitionFees: parseFloat(e.target.value) || 0,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
                <p className="text-sm text-gray-500 mt-1">
                  Monthly: â‚¹
                  {(createFeeStructureData.tuitionFees / 12).toFixed(2)}
                </p>
              </div>

              {/* Exam Fees */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Total Exam Fees (â‚¹)
                </label>
                <input
                  type="number"
                  value={createFeeStructureData.examFees}
                  onChange={(e) =>
                    setCreateFeeStructureData({
                      ...createFeeStructureData,
                      examFees: parseFloat(e.target.value) || 0,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>

              {/* Other Fees */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Other Fees (â‚¹)
                </label>
                <input
                  type="number"
                  value={createFeeStructureData.otherFees}
                  onChange={(e) =>
                    setCreateFeeStructureData({
                      ...createFeeStructureData,
                      otherFees: parseFloat(e.target.value) || 0,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>

              {/* Total Display */}
              <div className="p-4 bg-indigo-50 rounded-lg">
                <div className="flex justify-between items-center">
                  <span className="text-lg font-semibold text-indigo-900">
                    Total Amount:
                  </span>
                  <span className="text-2xl font-bold text-indigo-600">
                    â‚¹
                    {(
                      createFeeStructureData.admissionFee +
                      createFeeStructureData.registrationFee +
                      createFeeStructureData.tuitionFees +
                      createFeeStructureData.examFees +
                      createFeeStructureData.otherFees
                    ).toLocaleString()}
                  </span>
                </div>
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button
                onClick={handleCreateFeeStructure}
                disabled={!createFeeStructureData.className}
                className="flex-1 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                Create Fee Structure
              </button>
              <button
                onClick={() => {
                  setShowCreateFeeStructureModal(false);
                  setCreateFeeStructureData({
                    className: '',
                    admissionFee: 0,
                    registrationFee: 0,
                    tuitionFees: 0,
                    examFees: 0,
                    otherFees: 0,
                  });
                }}
                className="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 font-medium"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Assign Fee Modal */}
      {showAssignFeeModal && selectedRecord && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-8 max-w-md w-full">
            <h2 className="text-2xl font-bold text-gray-900 mb-6">
              Assign Fee to Student
            </h2>

            <div className="mb-4">
              <p className="text-sm text-gray-600">Student Name</p>
              <p className="text-lg font-semibold text-gray-900">
                {selectedRecord.studentName}
              </p>
            </div>

            <div className="mb-4">
              <p className="text-sm text-gray-600">Class</p>
              <p className="text-lg font-semibold text-gray-900">
                {selectedRecord.class}
              </p>
            </div>

            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Select Fee Structure <span className="text-red-500">*</span>
              </label>
              <select
                value={selectedFeeStructureId}
                onChange={(e) => setSelectedFeeStructureId(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
              >
                <option value="">Select a fee structure...</option>
                {feeStructures
                  .filter((s) => s.className === selectedRecord.class)
                  .map((structure) => (
                    <option key={structure.id} value={structure.id}>
                      {structure.className} - â‚¹
                      {structure.totalAmount.toLocaleString()} (
                      {structure.academicYear})
                    </option>
                  ))}
              </select>
            </div>

            <div className="flex gap-3">
              <button
                onClick={async () => {
                  try {
                    if (!selectedFeeStructureId) {
                      alert('Please select a fee structure');
                      return;
                    }

                    const orgId = await ApiService.getCurrentOrgId();
                    const classId = classIdMap.get(selectedRecord.class);

                    if (!classId) {
                      alert('Class ID not found');
                      return;
                    }

                    // Get the selected fee structure
                    const feeStructure = feeStructures.find(
                      (s) => s.id === selectedFeeStructureId,
                    );

                    if (!feeStructure) {
                      alert('Fee structure not found');
                      return;
                    }

                    // Prepare fee data
                    const feeData = {
                      fee_structure_id: selectedFeeStructureId,
                      components: {
                        admission_fee: feeStructure.components.admissionFee,
                        registration_fee:
                          feeStructure.components.registrationFee,
                        tuition_fees: feeStructure.components.tuitionFees,
                        exam_fees: feeStructure.components.examFees,
                        other_fees: feeStructure.components.otherFees,
                      },
                      academic_year: selectedYear,
                      due_date: '31/03/2025',
                      description: `Fee for ${selectedRecord.class}`,
                      fee_type: 'annual',
                    };

                    // Call API to assign fee
                    await ApiService.createStudentFee(
                      orgId,
                      classId,
                      selectedRecord.studentId,
                      feeData,
                    );

                    alert('Fee assigned successfully!');
                    setShowAssignFeeModal(false);
                    setSelectedFeeStructureId('');

                    // Reload data
                    await handleClassSelection(selectedRecord.class);
                  } catch (error) {
                    console.error('Error assigning fee:', error);
                    alert('Failed to assign fee. Please try again.');
                  }
                }}
                disabled={!selectedFeeStructureId}
                className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                Assign Fee
              </button>
              <button
                onClick={() => {
                  setShowAssignFeeModal(false);
                  setSelectedFeeStructureId('');
                }}
                className="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 font-medium"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Edit Payment Modal */}
      {showEditPaymentModal && editingPayment && selectedRecord && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold text-gray-900 mb-6">
              Edit Payment
            </h2>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Amount (â‚¹) <span className="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  value={editingPayment.amount}
                  onChange={(e) =>
                    setEditingPayment({
                      ...editingPayment,
                      amount: parseFloat(e.target.value) || 0,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Date <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={editingPayment.date}
                  onChange={(e) =>
                    setEditingPayment({
                      ...editingPayment,
                      date: e.target.value,
                    })
                  }
                  placeholder="DD/MM/YYYY"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Receipt Number <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={editingPayment.receiptNumber}
                  onChange={(e) =>
                    setEditingPayment({
                      ...editingPayment,
                      receiptNumber: e.target.value,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Payment Method
                </label>
                <select
                  value={editingPayment.method}
                  onChange={(e) =>
                    setEditingPayment({
                      ...editingPayment,
                      method: e.target.value as Payment['method'],
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                >
                  <option value="Cash">Cash</option>
                  <option value="Online">Online</option>
                  <option value="Cheque">Cheque</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                  <option value="UPI">UPI</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Description
                </label>
                <input
                  type="text"
                  value={editingPayment.description}
                  onChange={(e) =>
                    setEditingPayment({
                      ...editingPayment,
                      description: e.target.value,
                    })
                  }
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Month (Optional)
                </label>
                <input
                  type="text"
                  value={editingPayment.month || ''}
                  onChange={(e) =>
                    setEditingPayment({
                      ...editingPayment,
                      month: e.target.value,
                    })
                  }
                  placeholder="e.g., January 2025"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Remarks
                </label>
                <textarea
                  value={editingPayment.remarks}
                  onChange={(e) =>
                    setEditingPayment({
                      ...editingPayment,
                      remarks: e.target.value,
                    })
                  }
                  rows={3}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-900 bg-white"
                />
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button
                onClick={async () => {
                  try {
                    const orgId = await ApiService.getCurrentOrgId();

                    await ApiService.updatePayment(
                      orgId,
                      selectedRecord.id.replace('unassigned-', ''),
                      editingPayment.id,
                      {
                        amount: editingPayment.amount,
                        date: editingPayment.date,
                        receipt_number: editingPayment.receiptNumber,
                        method: editingPayment.method,
                        description: editingPayment.description,
                        month: editingPayment.month,
                        remarks: editingPayment.remarks,
                      },
                    );

                    alert('Payment updated successfully!');
                    setShowEditPaymentModal(false);
                    setEditingPayment(null);

                    // Refresh the details by closing and reopening
                    setShowDetailsModal(false);
                  } catch (error) {
                    console.error('Error updating payment:', error);
                    alert('Failed to update payment. Please try again.');
                  }
                }}
                className="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 font-medium"
              >
                Save Changes
              </button>
              <button
                onClick={() => {
                  setShowEditPaymentModal(false);
                  setEditingPayment(null);
                }}
                className="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 font-medium"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Delete Payment Confirmation Modal */}
      {showDeletePaymentModal && editingPayment && selectedRecord && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-8 max-w-md w-full">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">
              Delete Payment
            </h2>
            <p className="text-gray-700 mb-6">
              Are you sure you want to delete this payment of{' '}
              <strong>â‚¹{editingPayment.amount.toLocaleString()}</strong>? This
              action cannot be undone.
            </p>

            <div className="flex gap-3">
              <button
                onClick={async () => {
                  try {
                    const orgId = await ApiService.getCurrentOrgId();

                    await ApiService.deletePayment(
                      orgId,
                      selectedRecord.id.replace('unassigned-', ''),
                      editingPayment.id,
                    );

                    alert('Payment deleted successfully!');
                    setShowDeletePaymentModal(false);
                    setEditingPayment(null);

                    // Refresh the details by closing and reopening
                    setShowDetailsModal(false);
                  } catch (error) {
                    console.error('Error deleting payment:', error);
                    alert('Failed to delete payment. Please try again.');
                  }
                }}
                className="flex-1 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-medium"
              >
                Delete
              </button>
              <button
                onClick={() => {
                  setShowDeletePaymentModal(false);
                  setEditingPayment(null);
                }}
                className="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 font-medium"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
